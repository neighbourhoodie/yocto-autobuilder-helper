From 89aa42a28dff79e42bd96d491dcdf66113372327 Mon Sep 17 00:00:00 2001
From: Ninette Adhikari <13760198+ninetteadhikari@users.noreply.github.com>
Date: Tue, 5 Mar 2024 18:16:16 +0100
Subject: [PATCH 1/2] cve-report: Reformat txt recipe list per branch
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Yocto gathers the amount of CVEs per branch at the top of their metrics view.
However, the presentation of this information is not descriptive enough and it’s spread across several files.
This change adds collapsible, nested lists to show all cve information.

Show current CVE count per release,
parse txt files with CVE lists to group them by project and display their total CVE count.
Inline this data on the matrics-page in details elements so there’s no need to navigate away.

The current output includes the count of cve's and the cve-urls. No data is lost here, it looks like:

CVE counts by recipes:

linux-yocto: 134
  https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-1999-0524
  https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-1999-0656
  ...

bluez5: 2
  https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2022-3563
  https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2022-3637
...
---
 scripts/cve-report.py | 34 ++++++++++++++++++----------------
 1 file changed, 18 insertions(+), 16 deletions(-)

diff --git a/scripts/cve-report.py b/scripts/cve-report.py
index 203ea6d..38f3069 100755
--- a/scripts/cve-report.py
+++ b/scripts/cve-report.py
@@ -12,7 +12,6 @@ with open(jsonfile) as f:
     cvedata = json.load(f)
 
 cves = dict()
-recipe_counts = {}
 
 for recipe in cvedata['package']:
     if recipe['name'] in ignored_recipes:
@@ -24,21 +23,24 @@ for recipe in cvedata['package']:
             if i["id"] in cves:
                 cves[i["id"]] += ":" + recipe['name']
             else:
-                 cves[i["id"]] = recipe['name']
+                cves[i["id"]] = recipe['name']
 
-print("Found %d unpatched CVEs" % len(cves))
-for cve in sorted(cves.keys()):
-    print("%s: %s https://web.nvd.nist.gov/view/vuln/detail?vulnId=%s *" % (cve, cves[cve], cve))
+recipe_counts = {}
 
-for cve in cves:
-    recipename = cves[cve]
-    if recipename in recipe_counts:
-        recipe_counts[recipename] += 1
+for cve, name in cves.items():
+    if name not in recipe_counts:
+        recipe_counts[name] = {'count': 1, 'cves': [f"https://web.nvd.nist.gov/view/vuln/detail?vulnId={cve}"]}
     else:
-        recipe_counts[recipename] = 1
-
-
-print("\n")
-print("Summary of CVE counts by recipes:\n")
-for recipe, count in sorted(recipe_counts.items(), key=lambda x: x[1], reverse=True):
-    print("  %s: %s" % (recipe, count))
+        recipe_counts[name]['count'] += 1
+        recipe_counts[name]['cves'].append(f"https://web.nvd.nist.gov/view/vuln/detail?vulnId={cve}")
+
+formatted_data = {}
+for name, info in sorted(recipe_counts.items(), key=lambda x:x[1]['count'], reverse= True):
+    formatted_data[f"{name}: {info['count']}"] = info['cves']
+
+print("CVE counts by recipes:")
+for name, cves in formatted_data.items():
+    print("")
+    print(name)
+    for cve in cves:
+        print(f"  {cve}")
-- 
2.34.1

