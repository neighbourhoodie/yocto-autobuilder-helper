From 6172f47aac8701a6c57a37a0bfeb141767402dee Mon Sep 17 00:00:00 2001
Message-ID: <6172f47aac8701a6c57a37a0bfeb141767402dee.1712072937.git.13760198+ninetteadhikari@users.noreply.github.com>
In-Reply-To: <cover.1712072937.git.13760198+ninetteadhikari@users.noreply.github.com>
References: <cover.1712072937.git.13760198+ninetteadhikari@users.noreply.github.com>
From: Ninette Adhikari <13760198+ninetteadhikari@users.noreply.github.com>
Date: Tue, 5 Mar 2024 18:16:16 +0100
Subject: [PATCH 1/2] cve-report: Generate json recipe list per branch

including count and cve urls

output looks like

...
"bluez5": {
  "count": 2,
  "cves": [
    "https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2022-3563",
    "https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2022-3637"
  ]
},
"busybox": {
  "count": 4,
  "cves": [
    "https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2023-42363",
    "https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2023-42364",
    "https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2023-42365",
    "https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2023-42366"
   ]
  },
---
 scripts/cve-report.py | 24 ++++++++----------------
 scripts/run-cvecheck  |  2 +-
 2 files changed, 9 insertions(+), 17 deletions(-)

diff --git a/scripts/cve-report.py b/scripts/cve-report.py
index 203ea6d..96d38fa 100755
--- a/scripts/cve-report.py
+++ b/scripts/cve-report.py
@@ -12,7 +12,6 @@ with open(jsonfile) as f:
     cvedata = json.load(f)
 
 cves = dict()
-recipe_counts = {}
 
 for recipe in cvedata['package']:
     if recipe['name'] in ignored_recipes:
@@ -24,21 +23,14 @@ for recipe in cvedata['package']:
             if i["id"] in cves:
                 cves[i["id"]] += ":" + recipe['name']
             else:
-                 cves[i["id"]] = recipe['name']
+                cves[i["id"]] = recipe['name']
 
-print("Found %d unpatched CVEs" % len(cves))
-for cve in sorted(cves.keys()):
-    print("%s: %s https://web.nvd.nist.gov/view/vuln/detail?vulnId=%s *" % (cve, cves[cve], cve))
+structured_data = {}
 
-for cve in cves:
-    recipename = cves[cve]
-    if recipename in recipe_counts:
-        recipe_counts[recipename] += 1
-    else:
-        recipe_counts[recipename] = 1
+for cve, name in cves.items():
+    if name not in structured_data:
+        structured_data[name] = {'count': 0, 'cves': []}
+    structured_data[name]['count'] += 1
+    structured_data[name]['cves'].append('https://web.nvd.nist.gov/view/vuln/detail?vulnId=%s' % cve)
 
-
-print("\n")
-print("Summary of CVE counts by recipes:\n")
-for recipe, count in sorted(recipe_counts.items(), key=lambda x: x[1], reverse=True):
-    print("  %s: %s" % (recipe, count))
+print(json.dumps(structured_data, indent="\t"))
diff --git a/scripts/run-cvecheck b/scripts/run-cvecheck
index 373f57c..1829d30 100755
--- a/scripts/run-cvecheck
+++ b/scripts/run-cvecheck
@@ -92,7 +92,7 @@ if [ -e tmp/log/cve/cve-summary.json ]; then
     if [ "$PUSH" = "1" ]; then
         git -C $METRICSDIR push
     fi
-    $OURDIR/cve-report.py tmp/log/cve/cve-summary.json > $RESULTSDIR/cve-status-$BRANCH.txt
+    $OURDIR/cve-report.py tmp/log/cve/cve-summary.json > $RESULTSDIR/cve-status-$BRANCH.json
 fi
 
 if [ "$BRANCH" = "master" ]; then
-- 
2.44.0

